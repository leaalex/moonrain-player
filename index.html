<html>
	<head>
		<meta charset="utf-8">
	</head>
	<style>
		video{
			border: 1px solid;
			height: 170;
		}
		.one-track{
			display: inline-block;
			height: 20px;
			/*border: 1px solid black;*/
				}
		.videoblock{
			height: 400;
		}
	</style>
	<script src="script.js" charset="utf-8"></script>
<body>


<div id="id" class="media-container" data-wight="1280" data-src="https://rec.edu-kuban.ru/2016-06-17.10-19-41.6f5ef8098b922eb3_12345678/" style="background: aliceblue;margin-bottom: 100px;">
</div>
<div class="media-container" data-widht="1280" data-src="https://rec.edu-kuban.ru/2016-06-03.17-10-57.3950c7fb2ff18e0a_12356/" style="background: #c1eded;">
</div>
</body>
</html>


<script type="text/javascript">

console.log("v0.1.53 'length' ");

function Constructor(selector){

	// Седектор по которому происходит поиск элементов для подключения плеера
	var selector = selector || ".media-container";
	this.meta = {}

	function watch(object, event){
		var result;
		object.addEventListener(event, function(){})
	}

	function Player(HTMLElement){
		this.container = HTMLElement;

		this.blockMedia = createElement("div", genID("blockMedia"),  "blockMedia", {width:"auto"})
		console.log("Создано:",this.blockMedia);

		this.blockControls = createElement("div", genID("blockControls"), "blockControls");
		this.timeline = createElement("div", genID("timeline"), "timeline");
		this.blockControls.appendChild(this.timeline);
		console.log("Создано:",this.blockControls);

		this.blockHide = createElement("div", genID("blockHide"),"blockHide");
		console.log("Создано:",this.blockHide);

		this.container.appendChild(this.blockMedia);
		this.container.appendChild(this.blockControls);
		this.container.appendChild(this.blockHide);

		if(this.container.dataset.src){
			this.src = this.container.dataset.src;
		}
		else{
			console.error("Ошибка получения src!");
		}

		this.width = this.container.dataset.width || "";
		this.height = this.container.dataset.height || "";

		// Получеине обекта из JSON'а
		this.objectJSON = getObjectJSON("https://crossorigin.me/" + this.src + "metadata.json");

		//Получение всех instant и сортировка их по возростанию
		this.instants = (mediaObjects(this.objectJSON, "video", "instant").concat(mediaObjects(this.objectJSON, "audio", "instant"))).sort(function(a, b) {return a-b} );

		this.sortObjects = function(){
			var elementArray = {};
			for(var i = 0; i < this.objectJSON.video.length; i++){
				if(this.objectJSON.video[i].type != "SPEAKER_CHANGED"){
					var object = {};
					object.name = this.objectJSON.video[i].instant;
					object.type = 'video';
					object.duration = 0;
					object.filename = this.objectJSON.video[i].filename;
					object.html = createElement("video", genID("video"), false, {width: 200}, {src: this.src + this.objectJSON.video[i].filename, preload:"metadata"});
					elementArray[object.name] = object;
				}
			}
			for(var i = 0; i < this.objectJSON.audio.length; i++){
				if(this.objectJSON.audio[i].type != "SPEAKER_CHANGED"){
					var object = {};
					object.name = this.objectJSON.audio[i].instant;
					object.type = 'audio';
					object.duration = 0;
					object.filename = this.objectJSON.audio[i].filename;
					object.html = createElement("video", genID("audio"), false, {width: 100}, {src: this.src + this.objectJSON.audio[i].filename, preload:"metadata"});
					elementArray[object.name] = object;
				}
			}
			return elementArray;
		}.bind(this);


		function xxx(a, b, c){
		/*	console.log("time 0: ", a)
			console.log("time last: ", b)
			console.log("time last: ", (a-b));
			console.log("Last duration: ", c)
			console.log( (a - b)/1000 + c);*/
			//console.log("Длина последнего элемента: ", this.lastElementDuration);
			//console.log("общая длина: ",(this.instants[this.instants.length-1] - this.instants[0])/1000 + this.lastElementDuration);
		}

		this.lastElementDuration = 0;
		var div = {};
    var fullDuration = 0;
		this.mediaList = this.sortObjects();

		var video = createElement("video", genID("videoblock"), "videoblock", {"controls":""});
		video.src = this.src + this.mediaList[this.instants[0]].filename;
		this.blockMedia.appendChild(video);

		var testButton = createElement("button", "testButton", "testButton");
		testButton.innerHTML = "КНОПКА";
		this.blockMedia.appendChild(testButton);

		this.instants.forEach(function(element){
			div[this.mediaList[element].name] = createElement("div", genID(this.mediaList[element].name), "one-track");
			this.timeline.appendChild(div[this.mediaList[element].name]);
			this.blockHide.appendChild(this.mediaList[element].html);
			this.mediaList[element].html.addEventListener("loadedmetadata",function(){
				this.mediaList[element].duration = this.mediaList[element].html.duration;
      //  div[this.mediaList[element].name].innerHTML = this.mediaList[element].name;

				fullDuration = fullDuration + this.mediaList[element].duration;
				for(var p in div) {
						var dur = this.mediaList[p].duration;
						if(dur != 0){
							div[p].style.width = (dur * 100 / fullDuration) + '%';
						}
				}

				div[this.mediaList[element].name].style.background= "#"+((1<<24)*Math.random()|0).toString(16);
				var link = this.src + this.mediaList[element].filename;

				var nextVideo = 0;
				for(var i = 0; i < this.instants.length-1; i++){
						if(this.instants[i] == element){
							nextVideo = this.mediaList[this.instants[i+1]];
						}
				}

				div[this.mediaList[element].name].addEventListener("click", function(){
					video.src = link;
					//console.log(nextVideo);
				});

				var testVar = this.mediaList[element];
				testButton.addEventListener("click", function(){
					console.log(testVar);
				});

				video.addEventListener('ended', function(){
					//video.src = nextVideo;
				});



				/*for(var i = 0; i < this.instants.length-1; i++){
					if (this.instants[i] == element){
					video.addEventListener('ended', function(){
						video.src = pos.filename;
				});
				}
			}*/


				/*if(this.instants[this.instants.length - 1] == element){
					this.lastElementDuration = this.mediaList[element].duration;
					xxx(this.instants[this.instants.length-1], this.instants[0], this.lastElementDuration);
					console.log("это зыс:", this);
				};*/

			 }.bind(this))

		}.bind(this))


}

  this.playerList = [];
  this.init = function(){
    var mediaContainers = query(selector);

    mediaContainers.forEach(function(element){
		this.playerList.push(new Player(element))
	}.bind(this))

  };


}
</script>
